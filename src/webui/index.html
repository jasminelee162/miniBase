<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>MiniDB Web</title>
    <style>
      :root { --bg:#0b1220; --panel:#121a2b; --muted:#89a; --accent:#4ea1ff; --ok:#1fbf75; --err:#ff5c5c; }
      html,body { height:100%; }
      *, *::before, *::after { box-sizing: border-box; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:var(--bg); color:#e6edf3; }
      .wrap { max-width: 1400px; margin: 0 auto; padding: 20px; }
      .grid { display:grid; grid-template-columns: minmax(320px, 1fr) 1fr minmax(380px, 1fr); grid-template-rows: 1fr 1fr; gap:16px; align-items:stretch; justify-items: stretch; }
      .stretch { align-self: stretch; height: 100%; }
      /* 右侧列：三等分垂直布局，使 Logs/Metrics/Admin 上下紧凑且高度相近 */
      #rightCol { display:grid; grid-template-rows: 1fr 1fr 1fr; gap:12px; }
      h2 { margin: 8px 0 16px; font-weight:600; }
      .card { background:var(--panel); border:1px solid #1e2a44; border-radius:10px; padding:16px; width:100%; box-shadow: 0 3px 18px rgba(0,0,0,.25); }
      /* Login card narrower and centered */
      #loginView { max-width: 460px; margin: 48px auto; text-align:center; }
      #loginView .row { flex-direction: column; align-items: stretch; }
      #loginView input { width: 100%; }
      #loginView button { width: 100%; }
      #loginView .status { display:block; margin-top:6px; }
      .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      input, select, button, textarea { color:#e6edf3; background:#0f1726; border:1px solid #26334f; border-radius:8px; }
      input[type="text"], input[type="password"], input:not([type]) { padding:8px 10px; min-width:180px; }
      select { padding:8px 10px; }
      input::placeholder { color:#556; }
      button { padding:8px 12px; cursor:pointer; border-color:#2b3a5d; background:linear-gradient(180deg,#1a2742,#0f1726); }
      button:hover { border-color:#3a4f7c; }
      button.primary { background: linear-gradient(180deg, #2a69ff, #1e4dcc); border-color:#2050d0; }
      button.primary:hover { filter: brightness(1.05); }
      textarea { width: 100%; height: 160px; font-family: Consolas, monospace; padding:10px; }
      .fixed { height: 200px; overflow:auto; }
      .fixed.tall { height: 300px; }
      table { border-collapse: collapse; margin-top: 10px; width:100%; }
      th, td { border: 1px solid #1e2a44; padding: 8px 10px; }
      th { background:#0f1a31; text-align:left; }
      #log { color: var(--muted); }
      .muted { color: var(--muted); }
      .status { margin-left:8px; }
      .status.ok { color: var(--ok); }
      .status.err { color: var(--err); }
      .section-title { margin: 12px 0 6px; font-size:14px; letter-spacing:.3px; color:#cfd7e1; }
    </style>
  </head>
  <body>
    <div class="wrap">
    <h2>MiniDB Web</h2>
    <div id="grid" class="grid" style="grid-template-columns: 1fr;">

    <!-- 左侧：合并 AI + Metrics 为单卡 -->
    <div id="leftPanel" class="card stretch" style="display:none; grid-column: 1; grid-row: 1 / span 2;">
      <div class="section-title">AI Assistant</div>
      <textarea id="aiPrompt" class="fixed" placeholder="Ask MiniDB AI..."></textarea>
      <div class="row" style="margin-top:8px;">
        <button onclick="callAI()">Send</button>
      </div>
      <div id="aiReply" class="fixed tall" style="margin-top:8px;"></div>

      <div class="section-title" style="margin-top:16px;">Metrics</div>
      <div id="metricsBody" class="muted"></div>
    </div>

    <!-- 登录页 -->
    <div id="loginView" class="card">
      <div class="section-title">Login</div>
      <div class="row">
        <input id="u" placeholder="username" value="root" style="flex:1; min-width: 0;" />
        <input id="p" placeholder="password" value="root" type="password" style="flex:1; min-width: 0;" />
        <button class="primary" onclick="login()">Login</button>
        <span id="log" class="status"></span>
      </div>
    </div>

    <!-- 应用页（登录后显示） -->
    <div id="appView" class="card stretch" style="display:none; grid-column: 2; grid-row: 1 / span 2;">
      <div class="row">
        <div><strong>Current:</strong> <span id="currUser"></span> <span id="currRole" class="muted" style="margin-left:6px;"></span></div>
        <div class="muted">Press Ctrl+Enter to execute</div>
        <div style="flex:1"></div>
        <button onclick="logout()">Logout</button>
      </div>

      <div class="section-title">SQL</div>
      <textarea id="sql" class="fixed">SELECT username, role, created_at, last_login FROM __users__;</textarea>
      <div class="row" style="margin-top:8px;">
        <button id="execBtn" class="primary" onclick="execSQL()">Execute</button>
        <span id="execMsg" class="status muted"></span>
      </div>
      <div id="result" class="fixed tall" style="margin-top:8px;"></div>

      
    </div>

    <!-- 右侧：Logs（第1行）、Admin（第2行） -->
    <div id="logsPanel" class="card stretch" style="display:none; grid-column: 3; grid-row: 1;">
      <div class="section-title">Logs</div>
      <div class="row">
        <select id="logSelect"></select>
        <button onclick="loadLogs()">Open</button>
      </div>
      <pre id="logContent" class="fixed tall" style="white-space:pre-wrap; background:#0f1726; padding:10px;"></pre>
    </div>
    <div id="adminPanel" class="card stretch" style="display:none; grid-column: 3; grid-row: 2;">
      <div class="section-title">Create User (DBA only)</div>
      <div class="row">
        <input id="nu" placeholder="new username" />
        <input id="np" placeholder="new password" type="password" />
        <select id="nr">
          <option>DBA</option>
          <option>DEVELOPER</option>
          <option selected>ANALYST</option>
        </select>
        <button onclick="createUser()">Create</button>
        <span id="createMsg" class="status"></span>
      </div>
      <div class="section-title">Users</div>
      <div class="row" style="margin-bottom:8px;">
        <button onclick="refreshUsers()">Refresh</button>
        <input id="delUser" placeholder="username to delete" />
        <button onclick="deleteUser()">Delete</button>
        <span id="userMsg" class="status"></span>
      </div>
      <div id="userList" class="muted"></div>
      <div class="section-title">Dump / Import</div>
      <div class="row">
        <input id="dumpFile" placeholder="dump filename (e.g. dump.sql)" />
        <button onclick="dumpDB()">Dump</button>
        <input id="importFile" placeholder="import filename (e.g. dump.sql)" />
        <button onclick="importDB()">Import</button>
        <span id="dumpMsg" class="status"></span>
      </div>
    </div>

    </div>

    <script>
      let session = { ok:false, user:'', role:'' };

      function render() {
        const grid = document.getElementById('grid');
        const loginView = document.getElementById('loginView');
        const appView = document.getElementById('appView');
        const adminPanel = document.getElementById('adminPanel');
        const leftPanel = document.getElementById('leftPanel');
        const logsPanel = document.getElementById('logsPanel');
        const metricsPanel = null;
        if (session.ok) {
          grid.style.gridTemplateColumns = 'minmax(320px, 1fr) 1fr minmax(380px, 1fr)';
          loginView.style.display = 'none';
          appView.style.display = '';
          leftPanel.style.display = '';
          logsPanel.style.display = '';
          document.getElementById('currUser').textContent = session.user;
          document.getElementById('currRole').textContent = `(${session.role})`;
          adminPanel.style.display = (session.role === 'DBA') ? '' : 'none';
        } else {
          grid.style.gridTemplateColumns = '1fr';
          loginView.style.display = '';
          appView.style.display = 'none';
          leftPanel.style.display = 'none';
          logsPanel.style.display = 'none';
          adminPanel.style.display = 'none';
        }
      }

      async function login() {
        const u = document.getElementById('u').value;
        const p = document.getElementById('p').value;
        const r = await fetch('/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u, password:p})});
        const j = await r.json();
        session = { ok: !!j.ok, user: j.user || '', role: j.role || '' };
        document.getElementById('log').textContent = j.ok ? '' : 'Login failed';
        render();
      }

      async function logout() {
        await fetch('/auth/logout', { method:'POST' });
        session = { ok:false, user:'', role:'' };
        render();
      }

      function formatRole(v){
        const m = { '0':'DBA', '1':'DEVELOPER', '2':'ANALYST', DBA:'DBA', DEVELOPER:'DEVELOPER', ANALYST:'ANALYST' };
        return m[String(v)] ?? String(v);
      }
      function formatTime(v){
        const n = Number(v);
        if (!Number.isFinite(n) || n <= 0) return '';
        const d = new Date(n*1000);
        const pad = x=>String(x).padStart(2,'0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

      async function execSQL() {
        const btn = document.getElementById('execBtn');
        const msg = document.getElementById('execMsg');
        const div = document.getElementById('result');
        const sql = document.getElementById('sql').value;
        btn.disabled = true; msg.textContent = 'Running...'; div.textContent = '';
        const t0 = performance.now();
        try {
        const r = await fetch('/sql/execute', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({sql})});
          const text = await r.text();
          let j = {};
          try { j = text ? JSON.parse(text) : {}; } catch { j = { error: 'Invalid JSON response' }; }
          const dt = (performance.now() - t0).toFixed(1);
          if (!r.ok) {
            msg.textContent = `HTTP ${r.status} in ${dt} ms`;
            div.textContent = j.error || text || 'Request failed';
            return;
          }
          if (j.error) {
            msg.textContent = `Error in ${dt} ms`;
            div.textContent = j.error;
            return;
          }
          let rows = Array.isArray(j.rows) ? j.rows : [];
          let cols = Array.isArray(j.columns) ? j.columns : [];

          // 针对 __users__ 结果做显示友好化：隐藏 password_hash，角色转文本，时间格式化
          const isUsersQuery = cols.includes('username') && (cols.includes('role') || cols.includes('password_hash'));
          if (isUsersQuery) {
            const keepCols = cols.filter(c => c !== 'password_hash');
            const colIndex = Object.fromEntries(keepCols.map((c,i)=>[c,i]));
            const origIndex = Object.fromEntries(cols.map((c,i)=>[c,i]));
            const mapped = rows.map(row => {
              const out = new Array(keepCols.length).fill('');
              for (const c of keepCols) {
                const v = row[origIndex[c]];
                out[colIndex[c]] = (c === 'role') ? formatRole(v) : (c === 'created_at' || c === 'last_login') ? formatTime(v) : v;
              }
              return out;
            });
            cols = keepCols;
            rows = mapped;
          }

          if (j.message) {
            const info = document.createElement('div');
            info.className = 'muted';
            info.textContent = j.message;
            div.innerHTML = '';
            div.appendChild(info);
          } else {
            div.innerHTML = '';
          }

          msg.textContent = `${rows.length} row(s) in ${dt} ms`;
          if (cols.length === 0 && rows.length === 0) { div.textContent = div.textContent || '(0 rows)'; return; }
          let html = '<table><thead><tr>' + cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('') + '</tr></thead><tbody>';
          for (const row of rows) html += '<tr>' + row.map(v=>`<td>${escapeHtml(v)}</td>`).join('') + '</tr>';
        html += '</tbody></table>';
        div.innerHTML = html;
        } catch (e) {
          msg.textContent = 'Network error';
          div.textContent = String(e);
        } finally {
          btn.disabled = false;
        }
      }

      async function createUser() {
        const u = document.getElementById('nu').value.trim();
        const p = document.getElementById('np').value;
        const r = document.getElementById('nr').value;
        const msg = document.getElementById('createMsg');
        msg.textContent = '';
        const resp = await fetch('/auth/createUser', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u, password:p, role:r})});
        const j = await resp.json().catch(()=>({ok:false}));
        msg.textContent = j.ok ? 'Created' : 'Failed';
        if (j.ok) refreshUsers();
      }

      async function refreshUsers(){
        const list = document.getElementById('userList');
        list.textContent = 'Loading...';
        try {
          const r = await fetch('/auth/listUsers');
          const j = await r.json();
          if (!j.ok) { list.textContent = 'Forbidden'; return; }
          if (!Array.isArray(j.users) || j.users.length===0) { list.textContent = '(no users)'; return; }
          list.innerHTML = j.users.map(u=>`<div>${escapeHtml(u)}</div>`).join('');
        } catch(e){ list.textContent = String(e); }
      }

      async function deleteUser(){
        const u = document.getElementById('delUser').value.trim();
        const msg = document.getElementById('userMsg');
        msg.textContent = '';
        if (!u) { msg.textContent = 'username required'; return; }
        if (u === 'root') { msg.textContent = 'cannot delete root'; return; }
        const resp = await fetch('/auth/deleteUser', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u})});
        const j = await resp.json().catch(()=>({ok:false}));
        msg.textContent = j.ok ? 'Deleted' : 'Failed';
        if (j.ok) refreshUsers();
      }

      async function dumpDB(){
        const f = document.getElementById('dumpFile').value.trim() || 'dump.sql';
        const msg = document.getElementById('dumpMsg');
        msg.textContent = 'Dumping...';
        const r = await fetch('/db/dump', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({filename:f})});
        const j = await r.json().catch(()=>({ok:false}));
        msg.textContent = j.ok ? `Dumped to ${j.file||f}` : 'Dump failed';
      }

      async function importDB(){
        const f = document.getElementById('importFile').value.trim();
        const msg = document.getElementById('dumpMsg');
        if (!f) { msg.textContent = 'import filename required'; return; }
        msg.textContent = 'Importing...';
        const r = await fetch('/db/import', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({filename:f})});
        const j = await r.json().catch(()=>({ok:false}));
        msg.textContent = j.ok ? 'Import OK' : 'Import failed';
      }

      async function callAI(){
        const prompt = document.getElementById('aiPrompt').value;
        const out = document.getElementById('aiReply'); out.textContent = '...';
        try {
          const r = await fetch('/ai/complete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({prompt})});
          const j = await r.json();
          out.textContent = j.reply || JSON.stringify(j);
        } catch(e){ out.textContent = String(e); }
      }

      async function populateLogs(){
        const sel = document.getElementById('logSelect');
        sel.innerHTML = '';
        try {
          const r = await fetch('/logs/list'); const j = await r.json();
          if (!j.ok || !Array.isArray(j.files)) return;
          for (const f of j.files){ const o=document.createElement('option'); o.value=f; o.textContent=f; sel.appendChild(o);} 
          if (j.files.length>0) loadLogs();
        } catch {}
      }
      async function loadLogs(){
        const sel = document.getElementById('logSelect');
        const name = sel.value; const pre = document.getElementById('logContent'); pre.textContent = 'Loading...';
        try {
          const r = await fetch('/logs/read', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({file:name})});
          const j = await r.json();
          pre.textContent = (j.ok && j.content) ? j.content : 'Failed to read log';
          // 滚动到底部，显示最新日志
          pre.scrollTop = pre.scrollHeight;
        } catch(e){ pre.textContent = String(e); }
      }

      async function refreshMetrics(){
        try {
          const r = await fetch('/metrics');
          const j = await r.json();
          const el = document.getElementById('metricsBody');
          el.innerHTML = `
            <div>Hit Rate: ${((j.hit_rate||0)*100).toFixed(1)}%</div>
            <div>Pool Size: ${j.pool_size||0}</div>
            <div>Replacements: ${j.replacements||0}</div>
            <div>Writebacks: ${j.writebacks||0}</div>
            <div>IO Queue Depth: ${j.io_queue_depth||0}</div>
            <div>Avg Read Latency: ${(j.io_avg_read_ms||0).toFixed(3)} ms</div>
            <div>Avg Write Latency: ${(j.io_avg_write_ms||0).toFixed(3)} ms</div>
            <div>Read Ops: ${j.io_read_ops||0}</div>
            <div>Write Ops: ${j.io_write_ops||0}</div>
          `;
        } catch {}
      }

      // 初次渲染（可选：尝试获取当前会话）
      (async function init(){
        try {
          const r = await fetch('/auth/me');
          const j = await r.json();
          session = { ok: !!j.ok, user: j.user || '', role: j.role || '' };
        } catch {}
        render();
        populateLogs();
        setInterval(refreshMetrics, 1000);
      })();

      // 快捷键：Ctrl/Cmd+Enter 执行
      document.addEventListener('keydown', (e)=>{
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          const appView = document.getElementById('appView');
          if (appView.style.display !== 'none') execSQL();
        }
      });
    </script>
    </div>
  </body>
  </html>


